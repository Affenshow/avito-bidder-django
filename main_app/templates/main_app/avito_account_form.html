{% extends 'base.html' %}
{% load form_filters %}
{% load static %}

{% block title %}
    {{ form.instance.pk|yesno:"Редактировать,Добавить" }} аккаунт — Bidder PRO
{% endblock %}

{% block breadcrumb %}
    <a href="{% url 'avito-account-list' %}">Аккаунты</a>
    <span class="separator">/</span>
    <span class="current">{{ form.instance.pk|yesno:"Редактирование,Добавление" }}</span>
{% endblock %}

{% block page_title %}
    {{ form.instance.pk|yesno:"Редактировать аккаунт,Новый аккаунт" }}
{% endblock %}

{% block page_subtitle %}
    {{ form.instance.pk|yesno:"Изменение параметров подключения,Подключите аккаунт Avito для начала работы" }}
{% endblock %}

{% block content_actions %}
    <a href="{% url 'avito-account-list' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Назад
    </a>
{% endblock %}

{% block content %}
<div class="account-form-card">
    <form method="post" class="account-form" novalidate>
        {% csrf_token %}

        <!-- Non-field errors -->
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i>
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}

        <!-- Instructions -->
        <div class="form-instructions">
            <div class="fi-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="fi-content">
                <div class="fi-title">Где взять Client ID и Secret?</div>
                <div class="fi-text">
                    Перейдите в 
                    <a href="https://www.avito.ru/professionals/api" target="_blank" rel="noopener">
                        Настройки API Avito <i class="fas fa-external-link-alt"></i>
                    </a>
                    → Создайте приложение → Скопируйте данные.
                </div>
            </div>
        </div>

        <!-- Form Section -->
        <div class="form-section">
            <div class="form-section-header">
                <div class="form-section-icon blue">
                    <i class="fas fa-plug"></i>
                </div>
                <div>
                    <div class="form-section-title">Данные подключения</div>
                    <div class="form-section-desc">Заполните все поля для подключения аккаунта</div>
                </div>
            </div>

            <div class="form-section-body">
                {% for field in form.visible_fields %}
                    <div class="fg">
                        <label class="fg-label" for="{{ field.id_for_label }}">
                            {% if field.name == "name" %}
                                <i class="fas fa-tag"></i>
                            {% elif field.name == "avito_client_id" %}
                                <i class="fas fa-key"></i>
                            {% elif field.name == "avito_client_secret" %}
                                <i class="fas fa-lock"></i>
                            {% else %}
                                <i class="fas fa-circle"></i>
                            {% endif %}
                            {{ field.label }}
                        </label>

                        <div class="fg-input-wrap {% if field.name == 'avito_client_secret' %}fg-has-toggle{% endif %}">
                            {% if field.name == "avito_client_secret" %}
                                <input
                                    type="password"
                                    name="{{ field.html_name }}"
                                    id="{{ field.id_for_label }}"
                                    class="fg-input fg-input-secret"
                                    value="{{ field.value|default:'' }}"
                                    placeholder="Введите Client Secret"
                                    autocomplete="off"
                                >
                                <button type="button" class="fg-toggle-btn" onclick="toggleSecret(this)" title="Показать/скрыть">
                                    <i class="fas fa-eye"></i>
                                </button>
                            {% else %}
                                {{ field|add_class:"fg-input" }}
                            {% endif %}
                        </div>

                        {% if field.help_text %}
                            <div class="fg-hint">
                                <i class="fas fa-info-circle"></i> {{ field.help_text }}
                            </div>
                        {% endif %}

                        {% if field.errors %}
                            <div class="fg-error">
                                {% for error in field.errors %}
                                    <span><i class="fas fa-exclamation-circle"></i> {{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Connection Test (visual only) -->
        <div class="form-section" id="test-section" style="display:none;">
            <div class="form-section-header">
                <div class="form-section-icon green">
                    <i class="fas fa-wifi"></i>
                </div>
                <div>
                    <div class="form-section-title">Проверка подключения</div>
                    <div class="form-section-desc" id="test-status">Ожидание...</div>
                </div>
            </div>
        </div>

        <!-- Submit -->
        <div class="form-submit-section">
            <a href="{% url 'avito-account-list' %}" class="btn btn-secondary btn-lg">
                <i class="fas fa-times"></i> Отмена
            </a>
            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                <i class="fas fa-save"></i>
                {{ form.instance.pk|yesno:"Сохранить изменения,Подключить аккаунт" }}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_head %}
<style>
    /* ===== Form Card ===== */
    .account-form-card {
        max-width: 600px;
        margin: 0 auto;
    }

    /* ===== Instructions ===== */
    .form-instructions {
        display: flex;
        align-items: flex-start;
        gap: 14px;
        padding: 16px 20px;
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: var(--radius-md);
        margin-bottom: 20px;
    }
    .fi-icon {
        width: 36px; height: 36px;
        border-radius: 50%;
        background: #dbeafe;
        color: #3b82f6;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 0.9em;
    }
    .fi-title {
        font-weight: 600;
        font-size: 0.9em;
        color: #1e40af;
        margin-bottom: 4px;
    }
    .fi-text {
        font-size: 0.82em;
        color: #3b82f6;
        line-height: 1.5;
    }
    .fi-text a {
        color: #1e40af;
        font-weight: 600;
        text-decoration: none;
    }
    .fi-text a:hover {
        text-decoration: underline;
    }

    /* ===== Form Section ===== */
    .form-section {
        background: #fff;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-md);
        margin-bottom: 20px;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        transition: var(--transition);
    }
    .form-section:hover {
        box-shadow: var(--shadow-md);
    }
    .form-section-header {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 20px 24px;
        border-bottom: 1px solid var(--gray-100);
        background: var(--gray-50);
    }
    .form-section-icon {
        width: 40px; height: 40px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1em;
        flex-shrink: 0;
    }
    .form-section-icon.blue { background: #dbeafe; color: #3b82f6; }
    .form-section-icon.green { background: #d1fae5; color: #10b981; }
    .form-section-title {
        font-weight: 600;
        font-size: 0.95em;
        color: var(--gray-800);
    }
    .form-section-desc {
        font-size: 0.8em;
        color: var(--gray-500);
        margin-top: 2px;
    }
    .form-section-body {
        padding: 24px;
    }

    /* ===== Form Group ===== */
    .fg {
        margin-bottom: 20px;
    }
    .fg:last-child {
        margin-bottom: 0;
    }
    .fg-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85em;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 8px;
    }
    .fg-label i {
        color: var(--gray-400);
        width: 16px;
        text-align: center;
        font-size: 0.9em;
    }
    .fg-input-wrap {
        position: relative;
    }
    .fg-input {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-sm);
        font-family: inherit;
        font-size: 0.9em;
        color: var(--gray-800);
        background: #fff;
        transition: var(--transition);
        outline: none;
    }
    .fg-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79,70,229,0.1);
    }
    .fg-input::placeholder {
        color: var(--gray-400);
    }

    /* Secret field toggle */
    .fg-has-toggle .fg-input {
        padding-right: 48px;
    }
    .fg-toggle-btn {
        position: absolute;
        right: 4px;
        top: 50%;
        transform: translateY(-50%);
        width: 38px; height: 38px;
        border-radius: var(--radius-sm);
        border: none;
        background: transparent;
        color: var(--gray-400);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }
    .fg-toggle-btn:hover {
        background: var(--gray-100);
        color: var(--gray-600);
    }

    /* Secret field monospace */
    .fg-input-secret {
        font-family: 'Courier New', monospace;
        letter-spacing: 0.05em;
    }

    .fg-hint {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--gray-400);
        font-size: 0.78em;
        margin-top: 6px;
    }
    .fg-error {
        margin-top: 6px;
    }
    .fg-error span {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--danger);
        font-size: 0.8em;
        font-weight: 500;
    }

    /* ===== Submit ===== */
    .form-submit-section {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 8px;
    }

    /* ===== Alert ===== */
    .alert-danger {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 14px 18px;
        background: var(--danger-bg);
        border: 1px solid #fecaca;
        border-radius: var(--radius-md);
        color: var(--danger);
        font-size: 0.88em;
        font-weight: 500;
        margin-bottom: 20px;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
        .account-form-card {
            max-width: 100%;
        }
        .form-section-body {
            padding: 16px;
        }
        .form-section-header {
            padding: 16px;
        }
        .form-submit-section {
            flex-direction: column-reverse;
        }
        .form-submit-section .btn {
            width: 100%;
            justify-content: center;
        }
        .form-instructions {
            flex-direction: column;
            gap: 10px;
        }
    }
    @media (max-width: 480px) {
        .form-section-header {
            padding: 12px;
        }
        .form-section-body {
            padding: 12px;
        }
        .form-section-icon {
            width: 34px; height: 34px;
            font-size: 0.85em;
        }
        .fg-input {
            padding: 10px 12px;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== Toggle secret visibility =====
    window.toggleSecret = function(btn) {
        var input = btn.parentElement.querySelector('.fg-input-secret');
        var icon = btn.querySelector('i');
        if (input.type === 'password') {
            input.type = 'text';
            icon.className = 'fas fa-eye-slash';
        } else {
            input.type = 'password';
            icon.className = 'fas fa-eye';
        }
    };

    // ===== Focus animations =====
    document.querySelectorAll('.fg-input').forEach(function(input) {
        input.addEventListener('focus', function() {
            this.closest('.fg').classList.add('fg-focused');
        });
        input.addEventListener('blur', function() {
            this.closest('.fg').classList.remove('fg-focused');
        });
    });

    // ===== Validate on input =====
    document.querySelectorAll('.fg-input').forEach(function(input) {
        input.addEventListener('input', function() {
            var fg = this.closest('.fg');
            var error = fg.querySelector('.fg-error');
            if (error && this.value.trim().length > 0) {
                error.style.display = 'none';
            }
        });
    });

    // ===== Form submit animation =====
    var form = document.querySelector('.account-form');
    var submitBtn = document.getElementById('submitBtn');

    if (form && submitBtn) {
        form.addEventListener('submit', function() {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Сохранение...';
        });
    }

    // ===== Scroll to first error =====
    var firstError = document.querySelector('.fg-error, .alert-danger');
    if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // ===== Copy on click for Client ID =====
    document.querySelectorAll('.fg-input').forEach(function(input) {
        if (input.name === 'avito_client_id') {
            input.title = 'Кликните дважды для копирования';
            input.addEventListener('dblclick', function() {
                this.select();
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(this.value);
                    showMiniToast('Client ID скопирован');
                }
            });
        }
    });

    function showMiniToast(msg) {
        var toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;bottom:24px;right:24px;background:#1e293b;color:#fff;padding:10px 18px;border-radius:8px;font-size:0.85em;font-weight:600;z-index:9999;opacity:0;transform:translateY(8px);transition:all 0.3s;display:flex;align-items:center;gap:8px;';
        toast.innerHTML = '<i class="fas fa-check-circle" style="color:#10b981"></i> ' + msg;
        document.body.appendChild(toast);
        requestAnimationFrame(function() {
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';
        });
        setTimeout(function() {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(8px)';
            setTimeout(function() { toast.remove(); }, 300);
        }, 2000);
    }
});
</script>
{% endblock %}